/* HTTP UI - REST API Server - Adapted from ESP-IDF HTTP server example
 * Reference: D:\esp\esp-idf\examples\protocols\http_server\simple\
 */

#include "http_ui.h"
#include "config_mgr.h"
#include "net_mgr.h"
#include "sntp_client.h"
#include "udp_broadcast.h"
#include "version.h"
#include "diag.h"
#include "esp_log.h"
#include "esp_http_server.h"
#include "esp_tls_crypto.h"
#include "esp_system.h"
#include "esp_timer.h"
#include "cJSON.h"
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include <time.h>

static const char *TAG = "http_ui";

// Setup mode: Allow default password for limited time after first boot
#define SETUP_MODE_DURATION_SEC (15 * 60)  // 15 minutes in seconds
static time_t s_first_boot_timestamp = 0;

#define HTTPD_401 "401 UNAUTHORIZED"
#define MAX_AUTH_LEN 128
#define MAX_JSON_RESPONSE 2048

// Favicon data (32x32 .ico file)
static const unsigned char s_favicon_ico[] = {
  0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x20, 0x20, 0x00, 0x00, 0x01, 0x00,
  0x20, 0x00, 0xa8, 0x10, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x23, 0x2e,
  0x00, 0x00, 0x23, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfb,
  0xfb, 0xff, 0xe9, 0xe4, 0xde, 0xff, 0xeb, 0xe6, 0xe0, 0xff, 0xfd, 0xfc,
  0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xf6, 0xf4, 0xf1, 0xff, 0xa9, 0x94, 0x7e, 0xff, 0x8b, 0x6e,
  0x50, 0xff, 0x8a, 0x6e, 0x50, 0xff, 0xaf, 0x9b, 0x87, 0xff, 0xf9, 0xf7,
  0xf6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe,
  0xfe, 0xff, 0xfe, 0xfd, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xbc, 0xab,
  0x9a, 0xff, 0x92, 0x77, 0x5b, 0xff, 0xb6, 0xa4, 0x91, 0xff, 0xb7, 0xa5,
  0x93, 0xff, 0x8d, 0x71, 0x55, 0xff, 0xc6, 0xb7, 0xa9, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xfd, 0xfd, 0xfd, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xee, 0xea, 0xe6, 0xff, 0xa3, 0x8c, 0x75, 0xff, 0x92, 0x77,
  0x5b, 0xff, 0xd7, 0xcd, 0xc3, 0xff, 0x9e, 0x86, 0x70, 0xff, 0xb2, 0x9f,
  0x8c, 0xff, 0x6c, 0x48, 0x25, 0xff, 0x74, 0x52, 0x31, 0xff, 0xae, 0x99,
  0x86, 0xff, 0xa7, 0x91, 0x7c, 0xff, 0xd3, 0xc9, 0xbe, 0xff, 0x90, 0x75,
  0x58, 0xff, 0xa7, 0x91, 0x7b, 0xff, 0xf2, 0xee, 0xeb, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xab, 0x97,
  0x82, 0xff, 0x52, 0x27, 0x00, 0xff, 0x50, 0x25, 0x00, 0xff, 0x7e, 0x5e,
  0x3e, 0xff, 0xaa, 0x95, 0x80, 0xff, 0x9a, 0x80, 0x67, 0xff, 0xaf, 0x9c,
  0x88, 0xff, 0xb2, 0x9f, 0x8c, 0xff, 0x94, 0x7a, 0x5f, 0xff, 0xb0, 0x9c,
  0x88, 0xff, 0x77, 0x56, 0x35, 0xff, 0x50, 0x25, 0x00, 0xff, 0x53, 0x29,
  0x01, 0xff, 0xb5, 0xa3, 0x90, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa5, 0x8e, 0x78, 0xff, 0x51, 0x26,
  0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0x71, 0x4d, 0x2c, 0xff, 0xe3, 0xdc,
  0xd5, 0xff, 0x9c, 0x84, 0x6b, 0xff, 0x8c, 0x70, 0x53, 0xff, 0x8b, 0x6e,
  0x51, 0xff, 0xa2, 0x8b, 0x74, 0xff, 0xe1, 0xda, 0xd3, 0xff, 0x6a, 0x45,
  0x22, 0xff, 0x51, 0x26, 0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0xad, 0x99,
  0x84, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xe6, 0xe0, 0xd9, 0xff, 0x8e, 0x72, 0x56, 0xff, 0x7c, 0x5b,
  0x3a, 0xff, 0x74, 0x52, 0x2e, 0xff, 0xc0, 0xb0, 0xa1, 0xff, 0xf9, 0xf7,
  0xf6, 0xff, 0xe0, 0xd9, 0xd1, 0xff, 0xe2, 0xdb, 0xd4, 0xff, 0xf9, 0xf8,
  0xf6, 0xff, 0xb8, 0xa7, 0x95, 0xff, 0x73, 0x51, 0x2d, 0xff, 0x7b, 0x5b,
  0x3a, 0xff, 0x93, 0x78, 0x5d, 0xff, 0xea, 0xe5, 0xe0, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xfb, 0xfb, 0xfa, 0xff, 0xf9, 0xf8, 0xf6, 0xff, 0xd5, 0xca,
  0xbf, 0xff, 0x7b, 0x5a, 0x39, 0xff, 0xbf, 0xaf, 0x9f, 0xff, 0xed, 0xe8,
  0xe4, 0xff, 0xed, 0xe9, 0xe5, 0xff, 0xba, 0xa8, 0x97, 0xff, 0x7d, 0x5c,
  0x3b, 0xff, 0xda, 0xd0, 0xc7, 0xff, 0xf9, 0xf8, 0xf6, 0xff, 0xfc, 0xfb,
  0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xf8, 0xf6, 0xff, 0xe7, 0xe1,
  0xdb, 0xff, 0xf3, 0xf1, 0xee, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd4, 0xc9,
  0xbf, 0xff, 0x73, 0x50, 0x2d, 0xff, 0x69, 0x44, 0x1e, 0xff, 0x69, 0x44,
  0x1e, 0xff, 0x77, 0x55, 0x33, 0xff, 0xda, 0xd1, 0xc8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xf4, 0xf2, 0xef, 0xff, 0xeb, 0xe6, 0xe0, 0xff, 0xfb, 0xfa,
  0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xef, 0xeb, 0xe7, 0xff, 0xaa, 0x96, 0x80, 0xff, 0x9f, 0x87,
  0x6f, 0xff, 0xe2, 0xdb, 0xd3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xf7,
  0xf6, 0xff, 0x9f, 0x87, 0x6f, 0xff, 0x65, 0x3e, 0x17, 0xff, 0x81, 0x62,
  0x42, 0xff, 0xe7, 0xe1, 0xdb, 0xff, 0xfa, 0xf9, 0xf8, 0xff, 0x7f, 0x5f,
  0x41, 0xff, 0x51, 0x26, 0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0x87, 0x69,
  0x4d, 0xff, 0xfd, 0xfd, 0xfc, 0xff, 0xe4, 0xdd, 0xd6, 0xff, 0x81, 0x62,
  0x42, 0xff, 0x68, 0x43, 0x1d, 0xff, 0xab, 0x96, 0x81, 0xff, 0xfc, 0xfb,
  0xfa, 0xff, 0xff, 0xff, 0xff, 0xff, 0xde, 0xd6, 0xcd, 0xff, 0x9d, 0x85,
  0x6c, 0xff, 0xae, 0x9a, 0x85, 0xff, 0xf1, 0xee, 0xeb, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa6, 0x90,
  0x79, 0xff, 0x52, 0x27, 0x00, 0xff, 0x50, 0x25, 0x00, 0xff, 0x89, 0x6c,
  0x4f, 0xff, 0xfc, 0xfb, 0xfa, 0xff, 0xe2, 0xda, 0xd3, 0xff, 0x61, 0x39,
  0x14, 0xff, 0x53, 0x28, 0x00, 0xff, 0x53, 0x28, 0x00, 0xff, 0xb8, 0xa6,
  0x95, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9c, 0x84, 0x6b, 0xff, 0x53, 0x28,
  0x00, 0xff, 0x54, 0x29, 0x00, 0xff, 0xa5, 0x8e, 0x78, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xb0, 0x9c, 0x89, 0xff, 0x52, 0x27, 0x00, 0xff, 0x52, 0x28,
  0x00, 0xff, 0x66, 0x40, 0x1d, 0xff, 0xe8, 0xe3, 0xdd, 0xff, 0xf8, 0xf7,
  0xf5, 0xff, 0x82, 0x63, 0x44, 0xff, 0x50, 0x25, 0x00, 0xff, 0x53, 0x29,
  0x00, 0xff, 0xae, 0x9a, 0x85, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x97, 0x7e, 0x64, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0x78, 0x56, 0x36, 0xff, 0xf7, 0xf5,
  0xf3, 0xff, 0xee, 0xea, 0xe6, 0xff, 0x76, 0x54, 0x32, 0xff, 0x52, 0x27,
  0x00, 0xff, 0x53, 0x28, 0x00, 0xff, 0xb2, 0xa0, 0x8d, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xef, 0xeb, 0xe7, 0xff, 0xb6, 0xa4, 0x92, 0xff, 0xb8, 0xa7,
  0x95, 0xff, 0xf2, 0xee, 0xeb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xaa, 0x95,
  0x80, 0xff, 0x51, 0x26, 0x00, 0xff, 0x51, 0x27, 0x00, 0xff, 0x7a, 0x59,
  0x38, 0xff, 0xf2, 0xef, 0xeb, 0xff, 0xf2, 0xef, 0xec, 0xff, 0x71, 0x4e,
  0x2d, 0xff, 0x51, 0x26, 0x00, 0xff, 0x50, 0x25, 0x00, 0xff, 0x9f, 0x88,
  0x71, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xdb, 0xd3, 0xc9, 0xff, 0x82, 0x64, 0x44, 0xff, 0x74, 0x51,
  0x2e, 0xff, 0x72, 0x50, 0x2c, 0xff, 0xcf, 0xc3, 0xb7, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xde, 0xd6, 0xce, 0xff, 0xaf, 0x9b, 0x86, 0xff, 0xa8, 0x93,
  0x7d, 0xff, 0x7c, 0x5c, 0x3a, 0xff, 0xd0, 0xc4, 0xb8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xcc, 0xbf, 0xb2, 0xff, 0x7c, 0x5b, 0x3a, 0xff, 0xa5, 0x8f,
  0x78, 0xff, 0xab, 0x96, 0x81, 0xff, 0xdf, 0xd7, 0xcf, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xc9, 0xbc, 0xae, 0xff, 0x71, 0x4e, 0x2a, 0xff, 0x74, 0x51,
  0x2e, 0xff, 0x86, 0x68, 0x49, 0xff, 0xe0, 0xd8, 0xd1, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xf6, 0xf4, 0xf2, 0xff, 0xbc, 0xac, 0x9b, 0xff, 0x9d, 0x85,
  0x6d, 0xff, 0xa9, 0x94, 0x7e, 0xff, 0xe4, 0xdd, 0xd6, 0xff, 0xc5, 0xb7,
  0xa8, 0xff, 0x7a, 0x59, 0x37, 0xff, 0xcf, 0xc3, 0xb7, 0xff, 0xfb, 0xfa,
  0xf8, 0xff, 0xfd, 0xfd, 0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc5, 0xb6,
  0xa7, 0xff, 0x7c, 0x5b, 0x3a, 0xff, 0xb2, 0x9f, 0x8c, 0xff, 0xa2, 0x8b,
  0x73, 0xff, 0xa4, 0x8d, 0x76, 0xff, 0xb2, 0x9e, 0x8b, 0xff, 0x7c, 0x5b,
  0x3a, 0xff, 0xc9, 0xbc, 0xae, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xfc,
  0xfc, 0xff, 0xfa, 0xf9, 0xf8, 0xff, 0xca, 0xbd, 0xb0, 0xff, 0x7a, 0x59,
  0x37, 0xff, 0xcb, 0xbe, 0xb1, 0xff, 0xe1, 0xda, 0xd2, 0xff, 0xa7, 0x91,
  0x7b, 0xff, 0x9e, 0x86, 0x6d, 0xff, 0xc0, 0xb0, 0xa0, 0xff, 0xf8, 0xf6,
  0xf5, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfd, 0xff, 0xab, 0x97,
  0x81, 0xff, 0x91, 0x75, 0x59, 0xff, 0xb4, 0xa2, 0x8f, 0xff, 0x9c, 0x84,
  0x6b, 0xff, 0x98, 0x7f, 0x65, 0xff, 0xf8, 0xf6, 0xf4, 0xff, 0xc5, 0xb7,
  0xa8, 0xff, 0x73, 0x50, 0x2d, 0xff, 0x7c, 0x5c, 0x3b, 0xff, 0x96, 0x7d,
  0x62, 0xff, 0xec, 0xe7, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xae, 0x9a,
  0x86, 0xff, 0x73, 0x51, 0x2f, 0xff, 0xaf, 0x9c, 0x88, 0xff, 0xae, 0x9a,
  0x85, 0xff, 0x70, 0x4d, 0x2a, 0xff, 0xb7, 0xa5, 0x93, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xe9, 0xe3, 0xdd, 0xff, 0x93, 0x78, 0x5c, 0xff, 0x7c, 0x5b,
  0x3a, 0xff, 0x74, 0x52, 0x2e, 0xff, 0xcb, 0xbe, 0xb1, 0xff, 0xf5, 0xf3,
  0xf0, 0xff, 0x94, 0x79, 0x5e, 0xff, 0x9f, 0x87, 0x6f, 0xff, 0xb4, 0xa1,
  0x8e, 0xff, 0x8e, 0x72, 0x56, 0xff, 0xb2, 0x9f, 0x8b, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xec, 0xe7, 0xe3, 0xff, 0x8b, 0x6e, 0x52, 0xff, 0xb6, 0xa4,
  0x92, 0xff, 0x6c, 0x47, 0x22, 0xff, 0xad, 0x98, 0x84, 0xff, 0x8e, 0x72,
  0x56, 0xff, 0xdc, 0xd4, 0xcb, 0xff, 0xee, 0xea, 0xe6, 0xff, 0x6c, 0x47,
  0x24, 0xff, 0x51, 0x26, 0x00, 0xff, 0x52, 0x27, 0x00, 0xff, 0xb0, 0x9d,
  0x89, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa4, 0x8d, 0x76, 0xff, 0xaf, 0x9b,
  0x87, 0xff, 0x82, 0x63, 0x43, 0xff, 0x89, 0x6c, 0x4e, 0xff, 0xaa, 0x95,
  0x7f, 0xff, 0xad, 0x99, 0x84, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa8, 0x92,
  0x7c, 0xff, 0x51, 0x26, 0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0x71, 0x4e,
  0x2c, 0xff, 0xf3, 0xf0, 0xed, 0xff, 0xd5, 0xcb, 0xc1, 0xff, 0x91, 0x76,
  0x5b, 0xff, 0xa9, 0x93, 0x7d, 0xff, 0x6e, 0x4a, 0x25, 0xff, 0xb8, 0xa6,
  0x94, 0xff, 0x8c, 0x6f, 0x53, 0xff, 0xf1, 0xed, 0xea, 0xff, 0xee, 0xe9,
  0xe5, 0xff, 0x8b, 0x6e, 0x52, 0xff, 0xb8, 0xa6, 0x94, 0xff, 0x77, 0x55,
  0x33, 0xff, 0xb1, 0x9d, 0x8a, 0xff, 0x8c, 0x6f, 0x53, 0xff, 0xde, 0xd6,
  0xce, 0xff, 0xef, 0xeb, 0xe7, 0xff, 0x6c, 0x48, 0x25, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x53, 0x29, 0x01, 0xff, 0xb6, 0xa3, 0x91, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xa6, 0x91, 0x7a, 0xff, 0xab, 0x97, 0x82, 0xff, 0x8d, 0x71,
  0x54, 0xff, 0x94, 0x79, 0x5e, 0xff, 0xa6, 0x90, 0x79, 0xff, 0xb0, 0x9c,
  0x88, 0xff, 0xff, 0xff, 0xff, 0xff, 0xad, 0x99, 0x85, 0xff, 0x52, 0x27,
  0x00, 0xff, 0x50, 0x25, 0x00, 0xff, 0x72, 0x4f, 0x2d, 0xff, 0xf3, 0xf1,
  0xed, 0xff, 0xd8, 0xce, 0xc4, 0xff, 0x8e, 0x72, 0x57, 0xff, 0xad, 0x99,
  0x84, 0xff, 0x78, 0x57, 0x35, 0xff, 0xb8, 0xa6, 0x95, 0xff, 0x8c, 0x70,
  0x54, 0xff, 0xf2, 0xef, 0xec, 0xff, 0xff, 0xff, 0xff, 0xff, 0xb3, 0xa1,
  0x8d, 0xff, 0x8c, 0x6f, 0x52, 0xff, 0xae, 0x9a, 0x86, 0xff, 0x95, 0x7b,
  0x61, 0xff, 0xa0, 0x89, 0x71, 0xff, 0xf8, 0xf7, 0xf5, 0xff, 0xba, 0xa9,
  0x97, 0xff, 0x77, 0x56, 0x34, 0xff, 0x8a, 0x6e, 0x50, 0xff, 0xa5, 0x8f,
  0x78, 0xff, 0xf2, 0xee, 0xeb, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xa8, 0x92,
  0x7d, 0xff, 0x6f, 0x4c, 0x28, 0xff, 0xa8, 0x93, 0x7c, 0xff, 0xa6, 0x90,
  0x79, 0xff, 0x6c, 0x48, 0x24, 0xff, 0xb1, 0x9d, 0x8a, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xef, 0xeb, 0xe7, 0xff, 0xa2, 0x8b, 0x74, 0xff, 0x8a, 0x6d,
  0x50, 0xff, 0x77, 0x56, 0x33, 0xff, 0xc0, 0xb0, 0xa0, 0xff, 0xf7, 0xf5,
  0xf3, 0xff, 0x9b, 0x82, 0x69, 0xff, 0x98, 0x7e, 0x64, 0xff, 0xae, 0x99,
  0x85, 0xff, 0x89, 0x6c, 0x4f, 0xff, 0xba, 0xa9, 0x97, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfa, 0xf8, 0xf7, 0xff, 0xc8, 0xbb,
  0xad, 0xff, 0xa8, 0x92, 0x7d, 0xff, 0xaf, 0x9b, 0x86, 0xff, 0xe0, 0xd8,
  0xd0, 0xff, 0xba, 0xa8, 0x97, 0xff, 0x7d, 0x5c, 0x3b, 0xff, 0xda, 0xd1,
  0xc8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xfc,
  0xfc, 0xff, 0xb7, 0xa6, 0x94, 0xff, 0x7e, 0x5f, 0x3e, 0xff, 0xc3, 0xb4,
  0xa5, 0xff, 0xb0, 0x9c, 0x88, 0xff, 0xb2, 0x9f, 0x8c, 0xff, 0xc2, 0xb3,
  0xa3, 0xff, 0x7d, 0x5d, 0x3c, 0xff, 0xbc, 0xac, 0x9b, 0xff, 0xfe, 0xfd,
  0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd5, 0xcb,
  0xc0, 0xff, 0x7b, 0x5a, 0x38, 0xff, 0xbf, 0xaf, 0x9f, 0xff, 0xde, 0xd5,
  0xcd, 0xff, 0xad, 0x99, 0x84, 0xff, 0xa9, 0x93, 0x7e, 0xff, 0xcc, 0xbf,
  0xb3, 0xff, 0xfb, 0xfa, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd3, 0xc9,
  0xbe, 0xff, 0x76, 0x54, 0x32, 0xff, 0x68, 0x43, 0x1d, 0xff, 0x72, 0x4f,
  0x2c, 0xff, 0xd9, 0xcf, 0xc6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd2, 0xc7,
  0xbc, 0xff, 0x9d, 0x84, 0x6c, 0xff, 0x97, 0x7e, 0x64, 0xff, 0x7f, 0x5f,
  0x3f, 0xff, 0xdb, 0xd2, 0xc9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd8, 0xce,
  0xc4, 0xff, 0x7e, 0x5e, 0x3d, 0xff, 0x94, 0x7a, 0x5f, 0xff, 0x99, 0x80,
  0x66, 0xff, 0xd4, 0xc9, 0xbe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd3, 0xc8,
  0xbd, 0xff, 0x6f, 0x4b, 0x27, 0xff, 0x68, 0x43, 0x1c, 0xff, 0x79, 0x58,
  0x37, 0xff, 0xd9, 0xd0, 0xc6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xfe, 0xff, 0x94, 0x79, 0x60, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x52, 0x27, 0x00, 0xff, 0x77, 0x56, 0x35, 0xff, 0xf6, 0xf4,
  0xf2, 0xff, 0xeb, 0xe6, 0xe1, 0xff, 0x6f, 0x4b, 0x28, 0xff, 0x51, 0x26,
  0x00, 0xff, 0x52, 0x27, 0x00, 0xff, 0xb5, 0xa3, 0x91, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xe8, 0xe2, 0xdc, 0xff, 0xa4, 0x8e, 0x77, 0xff, 0xa7, 0x91,
  0x7b, 0xff, 0xeb, 0xe6, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xad, 0x98,
  0x85, 0xff, 0x51, 0x25, 0x00, 0xff, 0x51, 0x25, 0x00, 0xff, 0x73, 0x50,
  0x2e, 0xff, 0xef, 0xeb, 0xe7, 0xff, 0xf2, 0xef, 0xec, 0xff, 0x71, 0x4e,
  0x2c, 0xff, 0x52, 0x27, 0x00, 0xff, 0x50, 0x25, 0x00, 0xff, 0x9c, 0x84,
  0x6c, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xad, 0x99, 0x84, 0xff, 0x54, 0x2a, 0x01, 0xff, 0x52, 0x27,
  0x00, 0xff, 0x90, 0x75, 0x59, 0xff, 0xfc, 0xfc, 0xfb, 0xff, 0xe3, 0xdc,
  0xd6, 0xff, 0x63, 0x3c, 0x17, 0xff, 0x52, 0x27, 0x00, 0xff, 0x53, 0x29,
  0x00, 0xff, 0xbb, 0xaa, 0x99, 0xff, 0xff, 0xff, 0xff, 0xff, 0x94, 0x7a,
  0x5f, 0xff, 0x51, 0x26, 0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0x9c, 0x84,
  0x6b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xb3, 0xa0, 0x8d, 0xff, 0x52, 0x27,
  0x00, 0xff, 0x51, 0x27, 0x00, 0xff, 0x69, 0x44, 0x20, 0xff, 0xea, 0xe5,
  0xe0, 0xff, 0xfa, 0xf8, 0xf7, 0xff, 0x89, 0x6c, 0x4e, 0xff, 0x51, 0x27,
  0x00, 0xff, 0x56, 0x2c, 0x03, 0xff, 0xb5, 0xa2, 0x8f, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf4, 0xf1,
  0xee, 0xff, 0xb9, 0xa8, 0x96, 0xff, 0xb0, 0x9d, 0x89, 0xff, 0xea, 0xe5,
  0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xfa, 0xf9, 0xff, 0xad, 0x99,
  0x84, 0xff, 0x70, 0x4c, 0x28, 0xff, 0x8e, 0x73, 0x56, 0xff, 0xed, 0xe8,
  0xe3, 0xff, 0xfa, 0xf8, 0xf7, 0xff, 0x7e, 0x5e, 0x40, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x50, 0x25, 0x00, 0xff, 0x87, 0x69, 0x4d, 0xff, 0xfd, 0xfc,
  0xfc, 0xff, 0xea, 0xe5, 0xe0, 0xff, 0x8f, 0x73, 0x57, 0xff, 0x74, 0x52,
  0x2f, 0xff, 0xb8, 0xa6, 0x95, 0xff, 0xfd, 0xfd, 0xfd, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xe7, 0xe1, 0xdb, 0xff, 0xaf, 0x9b, 0x86, 0xff, 0xbd, 0xac,
  0x9c, 0xff, 0xf6, 0xf4, 0xf1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 0xfb, 0xff, 0xf1, 0xee,
  0xeb, 0xff, 0xfa, 0xf8, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc9, 0xbc,
  0xae, 0xff, 0x75, 0x52, 0x2f, 0xff, 0x75, 0x53, 0x30, 0xff, 0x76, 0x54,
  0x31, 0xff, 0x77, 0x55, 0x33, 0xff, 0xcf, 0xc4, 0xb8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xfa, 0xf9, 0xf8, 0xff, 0xf4, 0xf1, 0xef, 0xff, 0xfe, 0xfd,
  0xfd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf6, 0xf3, 0xf1, 0xff, 0xf1, 0xed,
  0xea, 0xff, 0xc8, 0xbb, 0xad, 0xff, 0x7a, 0x59, 0x38, 0xff, 0xcd, 0xc0,
  0xb4, 0xff, 0xf7, 0xf5, 0xf3, 0xff, 0xf7, 0xf5, 0xf3, 0xff, 0xc6, 0xb8,
  0xa9, 0xff, 0x79, 0x58, 0x36, 0xff, 0xce, 0xc2, 0xb5, 0xff, 0xf1, 0xed,
  0xea, 0xff, 0xf7, 0xf5, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xde, 0xd6,
  0xcd, 0xff, 0x7f, 0x60, 0x3f, 0xff, 0x6e, 0x4a, 0x26, 0xff, 0x70, 0x4d,
  0x29, 0xff, 0xcc, 0xbf, 0xb3, 0xff, 0xf5, 0xf2, 0xef, 0xff, 0xd2, 0xc7,
  0xbb, 0xff, 0xd4, 0xc9, 0xbe, 0xff, 0xf6, 0xf4, 0xf2, 0xff, 0xc4, 0xb5,
  0xa6, 0xff, 0x6e, 0x4a, 0x25, 0xff, 0x6e, 0x4a, 0x26, 0xff, 0x84, 0x66,
  0x47, 0xff, 0xe3, 0xdd, 0xd6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa0, 0x89, 0x72, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x52, 0x27, 0x00, 0xff, 0x71, 0x4e, 0x2c, 0xff, 0xdd, 0xd4,
  0xcc, 0xff, 0x92, 0x77, 0x5c, 0xff, 0x92, 0x78, 0x5c, 0xff, 0x90, 0x75,
  0x59, 0xff, 0x98, 0x7e, 0x64, 0xff, 0xdd, 0xd4, 0xcc, 0xff, 0x6a, 0x46,
  0x22, 0xff, 0x52, 0x27, 0x00, 0xff, 0x51, 0x26, 0x00, 0xff, 0xa9, 0x94,
  0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xb2, 0x9f, 0x8c, 0xff, 0x54, 0x2a, 0x01, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x85, 0x66, 0x48, 0xff, 0xa6, 0x90, 0x7a, 0xff, 0xa0, 0x88,
  0x71, 0xff, 0xa6, 0x91, 0x7a, 0xff, 0xaa, 0x96, 0x80, 0xff, 0x9a, 0x81,
  0x69, 0xff, 0xac, 0x98, 0x83, 0xff, 0x7e, 0x5e, 0x3e, 0xff, 0x50, 0x25,
  0x00, 0xff, 0x56, 0x2c, 0x04, 0xff, 0xbc, 0xab, 0x9a, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xf1,
  0xee, 0xff, 0xb3, 0xa1, 0x8d, 0xff, 0xa3, 0x8c, 0x75, 0xff, 0xe1, 0xda,
  0xd2, 0xff, 0x9f, 0x87, 0x71, 0xff, 0xb2, 0x9e, 0x8b, 0xff, 0x70, 0x4c,
  0x28, 0xff, 0x78, 0x56, 0x34, 0xff, 0xad, 0x99, 0x85, 0xff, 0xa7, 0x92,
  0x7d, 0xff, 0xdf, 0xd7, 0xce, 0xff, 0xa1, 0x89, 0x72, 0xff, 0xb7, 0xa5,
  0x93, 0xff, 0xf6, 0xf4, 0xf2, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xb4,
  0xa5, 0xff, 0x8c, 0x70, 0x53, 0xff, 0xb8, 0xa6, 0x94, 0xff, 0xb8, 0xa6,
  0x94, 0xff, 0x89, 0x6c, 0x4e, 0xff, 0xcc, 0xc0, 0xb3, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfa, 0xf8, 0xf7, 0xff, 0xb6, 0xa4,
  0x92, 0xff, 0x8d, 0x71, 0x54, 0xff, 0x8d, 0x71, 0x55, 0xff, 0xbc, 0xac,
  0x9b, 0xff, 0xfb, 0xfb, 0xfa, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xf3, 0xf1,
  0xee, 0xff, 0xf4, 0xf2, 0xef, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00
};
static const size_t s_favicon_ico_len = 4286;

// Logo data (200x62 .webp file)
// Generated from: xxd -i Xtragen-logo-200x62.webp
#include "xtragen_logo_data.h"

// State
static httpd_handle_t s_server = NULL;
static char s_auth_user[64] = "admin";
static char s_auth_pass[64] = "admin";
static char s_auth_digest[MAX_AUTH_LEN] = {0};  // Cached "Basic <base64>" string

/**
 * Generate Basic Auth digest: "Basic <base64(user:pass)>"
 * Based on ESP-IDF http_server example pattern
 */
static esp_err_t generate_auth_digest(const char* username, const char* password, char* digest, size_t digest_len)
{
    if (!username || !password || !digest || digest_len == 0) {
        return ESP_ERR_INVALID_ARG;
    }

    // Build "user:pass" string
    char* user_info = NULL;
    int rc = asprintf(&user_info, "%s:%s", username, password);
    if (rc < 0 || !user_info) {
        ESP_LOGE(TAG, "Failed to allocate memory for auth info");
        return ESP_ERR_NO_MEM;
    }

    // Calculate base64 length
    size_t b64_len = 0;
    esp_crypto_base64_encode(NULL, 0, &b64_len, (const unsigned char*)user_info, strlen(user_info));

    // Check if we have enough space (6 for "Basic " + b64_len + 1 for null)
    if (6 + b64_len + 1 > digest_len) {
        free(user_info);
        return ESP_ERR_INVALID_SIZE;
    }

    // Encode as "Basic <base64>"
    strcpy(digest, "Basic ");
    size_t out_len = 0;
    esp_crypto_base64_encode((unsigned char*)digest + 6, b64_len, &out_len,
                            (const unsigned char*)user_info, strlen(user_info));

    // Explicitly null-terminate to prevent trailing garbage when new digest is shorter
    digest[6 + out_len] = '\0';

    free(user_info);
    return ESP_OK;
}

/**
 * Check Basic Auth header
 * Returns ESP_OK if authorized, ESP_ERR_INVALID_STATE if not
 */
static esp_err_t check_basic_auth(httpd_req_t* req)
{
    // Get Authorization header
    size_t buf_len = httpd_req_get_hdr_value_len(req, "Authorization") + 1;
    if (buf_len <= 1) {
        // No Authorization header
        return ESP_ERR_INVALID_STATE;
    }

    char* buf = calloc(1, buf_len);
    if (!buf) {
        ESP_LOGE(TAG, "Failed to allocate memory for auth header");
        return ESP_ERR_NO_MEM;
    }

    if (httpd_req_get_hdr_value_str(req, "Authorization", buf, buf_len) != ESP_OK) {
        free(buf);
        return ESP_ERR_INVALID_STATE;
    }

    // Compare with expected digest
    bool authorized = (strcmp(s_auth_digest, buf) == 0);

    free(buf);
    return authorized ? ESP_OK : ESP_ERR_INVALID_STATE;
}

/**
 * Send 401 Unauthorized response
 */
static esp_err_t send_401(httpd_req_t* req)
{
    httpd_resp_set_status(req, HTTPD_401);
    httpd_resp_set_type(req, "application/json");
    httpd_resp_set_hdr(req, "WWW-Authenticate", "Basic realm=\"ESP32 Device\"");
    httpd_resp_set_hdr(req, "Connection", "close");
    httpd_resp_send(req, "{\"error\":\"Unauthorized\"}", HTTPD_RESP_USE_STRLEN);
    return ESP_OK;
}

/**
 * GET /status - Return device status as JSON
 */
static esp_err_t status_get_handler(httpd_req_t* req)
{
    // Check auth
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    // Get device info
    char device_id[32] = {0};
    char ip_str[16] = "0.0.0.0";
    char mac_str[18] = "00:00:00:00:00:00";
    char netmask_str[16] = "0.0.0.0";
    char gateway_str[16] = "0.0.0.0";
    config_mgr_get_string("sys/device_id", device_id, sizeof(device_id));
    net_mgr_get_ip(ip_str, sizeof(ip_str));
    net_mgr_get_mac(mac_str, sizeof(mac_str));
    net_mgr_get_netmask(netmask_str, sizeof(netmask_str));
    net_mgr_get_gateway(gateway_str, sizeof(gateway_str));

    const char* fw_version = version_get_string();
    uint32_t uptime_s = (uint32_t)(esp_timer_get_time() / 1000000ULL);
    uint32_t heap_free = esp_get_free_heap_size();

    int rssi = 0;
    net_mgr_get_rssi(&rssi);

    // Build JSON response
    cJSON* root = cJSON_CreateObject();
    if (!root) {
        httpd_resp_send_500(req);
        return ESP_FAIL;
    }

    cJSON_AddStringToObject(root, "device_id", device_id);
    cJSON_AddStringToObject(root, "ip", ip_str);
    cJSON_AddStringToObject(root, "mac", mac_str);
    cJSON_AddStringToObject(root, "netmask", netmask_str);
    cJSON_AddStringToObject(root, "gateway", gateway_str);
    cJSON_AddStringToObject(root, "fw_version", fw_version);
    cJSON_AddNumberToObject(root, "uptime_s", uptime_s);
    cJSON_AddNumberToObject(root, "heap_free", heap_free);
    cJSON_AddNumberToObject(root, "rssi", rssi);

    // UDP stats (placeholder - will be implemented when UDP module supports stats query)
    cJSON* udp_stats = cJSON_CreateObject();
    cJSON_AddItemToObject(root, "udp_stats", udp_stats);

    // SNTP status
    sntp_status_t sntp_status;
    if (sntp_client_get_status(&sntp_status) == ESP_OK) {
        const char* sntp_status_str = "idle";
        switch (sntp_status) {
            case SNTP_STATUS_IDLE: sntp_status_str = "idle"; break;
            case SNTP_STATUS_SYNCING: sntp_status_str = "syncing"; break;
            case SNTP_STATUS_SYNCED: sntp_status_str = "synced"; break;
            case SNTP_STATUS_ERROR: sntp_status_str = "error"; break;
        }
        cJSON_AddStringToObject(root, "sntp_status", sntp_status_str);

        // Add last sync time if synced
        time_t last_sync;
        if (sntp_client_get_last_sync_time(&last_sync) == ESP_OK) {
            cJSON_AddNumberToObject(root, "sntp_last_sync", (double)last_sync);
        }

        // Add timezone
        char timezone[64] = {0};
        if (sntp_client_get_timezone(timezone, sizeof(timezone)) == ESP_OK) {
            cJSON_AddStringToObject(root, "sntp_timezone", timezone);
        }
    }

    // Security warning if weak password (IMPLEMENTATION_PLAN.md requirement)
    if (config_mgr_has_weak_password()) {
        if (s_first_boot_time_ms > 0) {
            int64_t elapsed_ms = (esp_timer_get_time() / 1000) - s_first_boot_time_ms;
            int64_t remaining_ms = SETUP_MODE_DURATION_MS - elapsed_ms;

            if (remaining_ms > 0) {
                char warning[128];
                snprintf(warning, sizeof(warning),
                        "SETUP MODE: Default password active. %lld min remaining. Change password now!",
                        remaining_ms / 60000);
                cJSON_AddStringToObject(root, "security_warning", warning);
                cJSON_AddBoolToObject(root, "setup_mode", true);
            } else {
                cJSON_AddStringToObject(root, "security_warning",
                    "CRITICAL: Setup mode expired. HTTP UI will be disabled on next restart!");
                cJSON_AddBoolToObject(root, "setup_mode", false);
            }
        } else {
            cJSON_AddStringToObject(root, "security_warning", "Default password in use! Change immediately.");
        }
    }

    char* json_str = cJSON_PrintUnformatted(root);
    cJSON_Delete(root);

    if (!json_str) {
        httpd_resp_send_500(req);
        return ESP_FAIL;
    }

    httpd_resp_set_type(req, "application/json");
    httpd_resp_send(req, json_str, HTTPD_RESP_USE_STRLEN);

    free(json_str);
    return ESP_OK;
}

/**
 * GET /ui - Single Page Application
 */
static esp_err_t ui_spa_handler(httpd_req_t* req)
{
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    httpd_resp_set_type(req, "text/html");

    // Send SPA shell
    static const char html_head[] =
        "<!DOCTYPE html>"
        "<html lang=\"en\">"
        "<head>"
        "<meta charset=\"utf-8\"/>"
        "<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>"
        "<title>XT-ESP Control Panel</title>"
        "<link rel=\"icon\" href=\"/favicon.ico\" type=\"image/x-icon\"/>"
        "<style>"
        "body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;color:#333;display:flex;min-height:100vh;}"
        ".sidebar{width:260px;background:#2c3e50;color:#ecf0f1;display:flex;flex-direction:column;position:fixed;height:100vh;left:0;top:0;overflow:hidden;z-index:100;}"
        ".logo{padding:20px 15px;text-align:center;background:#ffffff;border-bottom:2px solid #1a252f;flex-shrink:0;}"
        ".logo img{max-width:90%;height:auto;display:block;margin:0 auto;}"
        ".menu{flex:1;overflow-y:auto;padding-top:10px;}"
        ".menu a{display:block;padding:15px 20px;color:#ecf0f1;text-decoration:none;border-left:3px solid transparent;transition:all 0.3s;cursor:pointer;}"
        ".menu a:hover{background:#34495e;border-left-color:#3498db;}"
        ".menu a.active{background:#34495e;border-left-color:#3498db;font-weight:bold;}"
        ".content{margin-left:260px;flex:1;padding:20px;width:calc(100vw - 260px);box-sizing:border-box;min-height:100vh;}"
        ".page-header{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}"
        ".page-header h1{margin:0;font-size:24px;color:#2c3e50;}"
        ".card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}"
        ".card h2{margin:0 0 15px;font-size:18px;border-bottom:2px solid:#3498db;padding-bottom:8px;color:#2c3e50;}"
        ".card h3{margin:16px 0 8px;font-size:14px;color:#666;}"
        ".form-group{margin-bottom:15px;}"
        ".form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#555;}"
        ".form-group input,.form-group select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;font-size:14px;}"
        ".form-group small{display:block;margin-top:4px;color:#666;font-size:12px;}"
        ".btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:all 0.3s;margin-right:10px;}"
        ".btn-primary{background:#3498db;color:#fff;}"
        ".btn-primary:hover{background:#2980b9;}"
        ".btn-primary:disabled{background:#95a5a6;cursor:not-allowed;}"
        ".btn-danger{background:#e74c3c;color:#fff;}"
        ".btn-danger:hover{background:#c0392b;}"
        ".btn-success{background:#27ae60;color:#fff;}"
        ".btn-success:hover{background:#229954;}"
        ".alert{padding:12px;margin-bottom:20px;border-radius:4px;}"
        ".alert-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;}"
        ".alert-warning{background:#fff3cd;border:1px solid #ffc107;color:#856404;}"
        ".alert-error{background:#f8d7da;border:1px solid:#dc3545;color:#721c24;}"
        ".alert-success{background:#d4edda;border:1px solid #28a745;color:#155724;}"
        ".toast{position:fixed;top:20px;right:20px;min-width:250px;padding:15px 20px;border-radius:4px;box-shadow:0 4px 6px rgba(0,0,0,0.2);z-index:1000;animation:slideIn 0.3s;}"
        ".toast-success{background:#27ae60;color:#fff;}"
        ".toast-error{background:#e74c3c;color:#fff;}"
        ".toast-info{background:#3498db;color:#fff;}"
        "@keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}"
        ".spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto;}"
        "@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}"
        ".loading-overlay{position:fixed;top:0;left:260px;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:999;}"
        ".hidden{display:none!important;}"
        ".dashboard-grid{display:grid;grid-template-columns:1fr;gap:16px;}"
        "@media(min-width:768px){.dashboard-grid{grid-template-columns:repeat(2,1fr);}}"
        "dl{display:grid;grid-template-columns:auto 1fr;gap:8px 16px;margin:0;}"
        "dt{font-weight:bold;color:#555;}"
        "dd{margin:0;}"
        ".badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;color:#fff;}"
        ".badge-good{background:#28a745;}"
        ".badge-fair{background:#ffc107;color:#333;}"
        ".badge-poor{background:#dc3545;}"
        ".badge-connected{background:#28a745;}"
        ".badge-connecting{background:#ffc107;color:#333;}"
        ".badge-disconnected{background:#6c757d;}"
        ".badge-error{background:#dc3545;}"
        ".badge-muted{background:#6c757d;}"
        "@media(max-width:768px){.sidebar{width:80px;}.logo{padding:10px 5px;}.logo img{max-width:90%;}.menu a{padding:12px 8px;text-align:center;font-size:11px;}.content{margin-left:80px;width:calc(100vw - 80px);}.loading-overlay{left:80px;}}"
        "</style>"
        "</head>"
        "<body>"
        "<div class=\"sidebar\">"
        "<div class=\"logo\"><img src=\"/logo.webp\" alt=\"ESP-NG\"/></div>"
        "<nav class=\"menu\">"
        "<a href=\"#status\" id=\"menu-status\">Status</a>"
        "<a href=\"#network\" id=\"menu-network\">Network</a>"
        "<a href=\"#udp\" id=\"menu-udp\">UDP</a>"
        "<a href=\"#system\" id=\"menu-system\">System</a>"
        "</nav>"
        "</div>"
        "<div class=\"content\">"
        "<div id=\"app-content\"></div>"
        "</div>"
        "<div id=\"loading-overlay\" class=\"loading-overlay hidden\">"
        "<div class=\"spinner\"></div>"
        "</div>";

    httpd_resp_sendstr_chunk(req, html_head);

    // JavaScript application
    static const char html_js[] =
        "<script>"
        // Toast notification function
        "function showToast(message,type){"
        "const toast=document.createElement('div');"
        "toast.className='toast toast-'+type;"
        "toast.textContent=message;"
        "document.body.appendChild(toast);"
        "setTimeout(()=>toast.remove(),4000);"
        "}"
        // Show/hide loading overlay
        "function showLoading(){document.getElementById('loading-overlay').classList.remove('hidden');}"
        "function hideLoading(){document.getElementById('loading-overlay').classList.add('hidden');}"
        // Update active menu item
        "function updateMenu(page){"
        "document.querySelectorAll('.menu a').forEach(a=>a.classList.remove('active'));"
        "const activeLink=document.getElementById('menu-'+page);"
        "if(activeLink)activeLink.classList.add('active');"
        "}"
        // Content templates
        "const templates={"
        "status:()=>{"
        "return `<div class=\"page-header\"><h1>Status Dashboard</h1></div>"
        "<div class=\"alert alert-info\">Loading status data...</div>`;"
        "},"
        "network:()=>{"
        "return `<div class=\"page-header\"><h1>Network Configuration</h1></div>"
        "<div class=\"card\"><h2>WiFi Settings</h2>"
        "<form id=\"wifi-form\">"
        "<div class=\"form-group\"><label>SSID:</label>"
        "<input type=\"text\" name=\"wifi_ssid\" id=\"wifi_ssid\" maxlength=\"32\" required/></div>"
        "<div class=\"form-group\"><label>Password:</label>"
        "<input type=\"password\" name=\"wifi_pass\" id=\"wifi_pass\" maxlength=\"64\"/>"
        "<small>Leave blank for open network</small></div>"
        "<button type=\"submit\" class=\"btn btn-primary\">Test & Apply Credentials</button>"
        "</form></div>"
        "<div class=\"card\"><h2>Time Synchronization (SNTP)</h2>"
        "<form id=\"sntp-form\">"
        "<div class=\"form-group\"><label>Primary NTP Server:</label>"
        "<input type=\"text\" name=\"sntp_server1\" id=\"sntp_server1\" maxlength=\"127\" placeholder=\"pool.ntp.org\"/>"
        "<small>e.g., pool.ntp.org, time.nist.gov</small></div>"
        "<div class=\"form-group\"><label>Secondary NTP Server:</label>"
        "<input type=\"text\" name=\"sntp_server2\" id=\"sntp_server2\" maxlength=\"127\" placeholder=\"time.google.com\"/>"
        "<small>Fallback server for redundancy</small></div>"
        "<div class=\"form-group\"><label>Timezone:</label>"
        "<select name=\"sntp_timezone\" id=\"sntp_timezone\">"
        "<option value=\"UTC0\">UTC</option>"
        "<option value=\"EST5EDT,M3.2.0/2,M11.1.0/2\">US Eastern (EST/EDT)</option>"
        "<option value=\"CST6CDT,M3.2.0/2,M11.1.0/2\">US Central (CST/CDT)</option>"
        "<option value=\"MST7MDT,M3.2.0/2,M11.1.0/2\">US Mountain (MST/MDT)</option>"
        "<option value=\"PST8PDT,M3.2.0/2,M11.1.0/2\">US Pacific (PST/PDT)</option>"
        "<option value=\"CET-1CEST,M3.5.0,M10.5.0/3\">Central European (CET/CEST)</option>"
        "<option value=\"GMT0BST,M3.5.0/1,M10.5.0\">UK (GMT/BST)</option>"
        "<option value=\"IST-5:30\">India (IST)</option>"
        "<option value=\"JST-9\">Japan (JST)</option>"
        "<option value=\"AEST-10AEDT,M10.1.0,M4.1.0/3\">Australia Eastern (AEST/AEDT)</option>"
        "</select>"
        "<small>Select timezone for correct local time display</small></div>"
        "<button type=\"submit\" class=\"btn btn-primary\">Save Time Settings</button>"
        "</form></div>`;"
        "},"
        "udp:()=>{"
        "return `<div class=\"page-header\"><h1>UDP Broadcast Configuration</h1></div>"
        "<div class=\"card\"><h2>UDP Broadcast Settings</h2>"
        "<form id=\"udp-form\">"
        "<div class=\"form-group\"><label>Broadcast Address:</label>"
        "<input type=\"text\" name=\"udp_addr\" id=\"udp_addr\" placeholder=\"255.255.255.255\" maxlength=\"15\"/>"
        "<small>IP address to broadcast to (255.255.255.255 for subnet broadcast)</small></div>"
        "<div class=\"form-group\"><label>Broadcast Port:</label>"
        "<input type=\"number\" name=\"udp_port\" id=\"udp_port\" min=\"1\" max=\"65535\" placeholder=\"9999\"/></div>"
        "<div class=\"form-group\"><label>Broadcast Interval (milliseconds):</label>"
        "<input type=\"number\" name=\"udp_interval_ms\" id=\"udp_interval_ms\" min=\"200\" max=\"5000\" step=\"100\"/>"
        "<small>How often to broadcast (200-5000 ms, e.g., 1000 = 1 Hz)</small></div>"
        "<button type=\"submit\" class=\"btn btn-primary\">Save Configuration</button>"
        "</form></div>`;"
        "},"
        "system:()=>{"
        "return `<div class=\"page-header\"><h1>System</h1></div>"
        "<div class=\"card\"><h2>Firmware Update</h2>"
        "<p>Update firmware via HTTP URL</p>"
        "<form id=\"ota-form\">"
        "<div class=\"form-group\"><label>Firmware URL:</label>"
        "<input type=\"url\" name=\"fw_url\" placeholder=\"http://example.com/firmware.bin\" required/></div>"
        "<button type=\"submit\" class=\"btn btn-success\">Start OTA Update</button>"
        "</form></div>"
        "<div class=\"card\"><h2>System Actions</h2>"
        "<button id=\"reboot-btn\" class=\"btn btn-danger\">Reboot Device</button>"
        "</div>`;"
        "}"
        "};"
        // Load and populate config values
        "async function loadConfig(){"
        "try{"
        "const res=await fetch('/config',{method:'GET',credentials:'include'});"
        "if(!res.ok)return;"
        "const config=await res.json();"
        "return config;"
        "}catch(err){console.error('Failed to load config:',err);return null;}"
        "}"
        // Router function
        "function navigate(page){"
        "const content=document.getElementById('app-content');"
        "if(templates[page]){content.innerHTML=templates[page]();updateMenu(page);attachHandlers();loadPageData(page);}"
        "else{content.innerHTML='<div class=\"alert alert-error\">Page not found</div>';}"
        "}"
        // Load page-specific data
        "async function loadPageData(page){"
        "if(page==='network'){"
        "const config=await loadConfig();"
        "if(config){"
        "if(config.sntp_server1)document.getElementById('sntp_server1').value=config.sntp_server1;"
        "if(config.sntp_server2)document.getElementById('sntp_server2').value=config.sntp_server2;"
        "if(config.sntp_timezone)document.getElementById('sntp_timezone').value=config.sntp_timezone;"
        "}"
        "}"
        "else if(page==='udp'){"
        "const config=await loadConfig();"
        "if(config){"
        "if(config.udp_addr)document.getElementById('udp_addr').value=config.udp_addr;"
        "if(config.udp_port)document.getElementById('udp_port').value=config.udp_port;"
        "if(config.udp_freq_hz){"
        "const interval_ms=Math.round(1000.0/config.udp_freq_hz);"
        "document.getElementById('udp_interval_ms').value=interval_ms;"
        "}"
        "}"
        "}"
        "}"
        // Attach form handlers
        "function attachHandlers(){"
        // WiFi form
        "const wifiForm=document.getElementById('wifi-form');"
        "if(wifiForm){"
        "wifiForm.addEventListener('submit',async(e)=>{"
        "e.preventDefault();"
        "const ssid=document.getElementById('wifi_ssid').value;"
        "const pass=document.getElementById('wifi_pass').value;"
        "if(!ssid){showToast('SSID is required','error');return;}"
        "showLoading();"
        "try{"
        "const res=await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},"
        "body:JSON.stringify({wifi_ssid:ssid,wifi_pass:pass})});"
        "const data=await res.json();"
        "hideLoading();"
        "if(data.status==='ok'){showToast('WiFi credentials applied successfully','success');}"
        "else{showToast('Failed: '+(data.error||'Unknown error'),'error');}"
        "}catch(err){hideLoading();showToast('Network error','error');}"
        "});"
        "}"
        // SNTP form
        "const sntpForm=document.getElementById('sntp-form');"
        "if(sntpForm){"
        "sntpForm.addEventListener('submit',async(e)=>{"
        "e.preventDefault();"
        "const server1=document.getElementById('sntp_server1').value;"
        "const server2=document.getElementById('sntp_server2').value;"
        "const timezone=document.getElementById('sntp_timezone').value;"
        "showLoading();"
        "try{"
        "const res=await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},"
        "body:JSON.stringify({sntp_server1:server1,sntp_server2:server2,sntp_timezone:timezone})});"
        "const data=await res.json();"
        "hideLoading();"
        "if(data.status==='ok'){showToast('Time settings saved successfully','success');}"
        "else{showToast('Failed to save: '+(data.error||'Unknown error'),'error');}"
        "}catch(err){hideLoading();showToast('Network error','error');}"
        "});"
        "}"
        // UDP form
        "const udpForm=document.getElementById('udp-form');"
        "if(udpForm){"
        "udpForm.addEventListener('submit',async(e)=>{"
        "e.preventDefault();"
        "const addr=document.getElementById('udp_addr').value;"
        "const port=parseInt(document.getElementById('udp_port').value);"
        "const interval_ms=parseInt(document.getElementById('udp_interval_ms').value);"
        "if(!addr||!port||!interval_ms){showToast('All fields are required','error');return;}"
        "const freq_hz=1000.0/interval_ms;"
        "showLoading();"
        "try{"
        "const res=await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},"
        "body:JSON.stringify({udp_addr:addr,udp_port:port,udp_freq_hz:freq_hz})});"
        "const data=await res.json();"
        "hideLoading();"
        "if(data.status==='ok'){showToast('UDP configuration saved','success');}"
        "else{showToast('Failed: '+(data.error||'Unknown'),'error');}"
        "}catch(err){hideLoading();showToast('Request failed','error');}"
        "});"
        "}"
        // OTA form
        "const otaForm=document.getElementById('ota-form');"
        "if(otaForm){"
        "otaForm.addEventListener('submit',async(e)=>{"
        "e.preventDefault();"
        "const url=e.target.fw_url.value;"
        "if(confirm('Start OTA update from: '+url+'?')){"
        "showLoading();"
        "try{"
        "const res=await fetch('/ota',{method:'POST',headers:{'Content-Type':'application/json'},"
        "body:JSON.stringify({url:url})});"
        "const data=await res.json();"
        "hideLoading();"
        "if(data.status==='ok'){showToast('OTA update started','success');}"
        "else{showToast('OTA failed: '+(data.error||'Unknown'),'error');}"
        "}catch(err){hideLoading();showToast('Request failed','error');}"
        "}"
        "});"
        "}"
        // Reboot button
        "const rebootBtn=document.getElementById('reboot-btn');"
        "if(rebootBtn){"
        "rebootBtn.addEventListener('click',async()=>{"
        "if(confirm('Reboot device now?')){"
        "showLoading();"
        "try{"
        "await fetch('/reboot',{method:'POST'});"
        "showToast('Device rebooting...','info');"
        "}catch(err){hideLoading();showToast('Reboot request failed','error');}"
        "}"
        "});"
        "}"
        "}"
        // Hash change listener
        "window.addEventListener('hashchange',()=>{"
        "const page=location.hash.slice(1)||'status';"
        "navigate(page);"
        "});"
        // Initial navigation
        "window.addEventListener('DOMContentLoaded',()=>{"
        "const page=location.hash.slice(1)||'status';"
        "navigate(page);"
        "});"
        "</script>";

    httpd_resp_sendstr_chunk(req, html_js);

    // Close HTML
    static const char html_close[] =
        "</body>"
        "</html>";

    httpd_resp_sendstr_chunk(req, html_close);
    httpd_resp_sendstr_chunk(req, NULL);
    return ESP_OK;
}

/**
 * GET /config - Get current configuration (JSON)
 */
static esp_err_t config_get_handler(httpd_req_t* req)
{
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    cJSON* root = cJSON_CreateObject();
    if (!root) {
        httpd_resp_send_err(req, HTTPD_500_INTERNAL_SERVER_ERROR, "Memory allocation failed");
        return ESP_FAIL;
    }

    // Get all config values
    char device_id[32] = {0};
    char wifi_ssid[33] = {0};
    char udp_addr[16] = {0};
    char sntp_server1[128] = {0};
    char sntp_server2[128] = {0};
    char sntp_timezone[64] = {0};
    uint32_t udp_port = 0;
    uint32_t udp_freq_mhz = 0;

    config_mgr_get_string("sys/device_id", device_id, sizeof(device_id));
    config_mgr_get_string("wifi/ssid", wifi_ssid, sizeof(wifi_ssid));
    config_mgr_get_string("udp/addr", udp_addr, sizeof(udp_addr));
    config_mgr_get_u32("udp/port", &udp_port);
    config_mgr_get_u32("udp/freq_hz", &udp_freq_mhz);
    config_mgr_get_string("sntp/server1", sntp_server1, sizeof(sntp_server1));
    config_mgr_get_string("sntp/server2", sntp_server2, sizeof(sntp_server2));
    config_mgr_get_string("sntp/timezone", sntp_timezone, sizeof(sntp_timezone));

    // Add all config
    cJSON_AddStringToObject(root, "device_id", device_id);
    cJSON_AddStringToObject(root, "wifi_ssid", wifi_ssid);
    cJSON_AddStringToObject(root, "udp_addr", udp_addr);
    cJSON_AddNumberToObject(root, "udp_port", udp_port);
    // Convert millihertz to Hz for JSON output
    cJSON_AddNumberToObject(root, "udp_freq_hz", (double)udp_freq_mhz / 1000.0);
    cJSON_AddStringToObject(root, "sntp_server1", sntp_server1);
    cJSON_AddStringToObject(root, "sntp_server2", sntp_server2);
    cJSON_AddStringToObject(root, "sntp_timezone", sntp_timezone);

    char* json_str = cJSON_PrintUnformatted(root);
    cJSON_Delete(root);

    if (!json_str) {
        httpd_resp_send_err(req, HTTPD_500_INTERNAL_SERVER_ERROR, "JSON serialization failed");
        return ESP_FAIL;
    }

    httpd_resp_set_type(req, "application/json");
    httpd_resp_sendstr(req, json_str);
    cJSON_free(json_str);
    return ESP_OK;
}

/**
 * POST /config - Update configuration
 */
static esp_err_t config_post_handler(httpd_req_t* req)
{
    // Check auth
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    // Read request body
    char* buf = malloc(req->content_len + 1);
    if (!buf) {
        httpd_resp_send_500(req);
        return ESP_FAIL;
    }

    int ret = httpd_req_recv(req, buf, req->content_len);
    if (ret <= 0) {
        free(buf);
        if (ret == HTTPD_SOCK_ERR_TIMEOUT) {
            httpd_resp_send_408(req);
        }
        return ESP_FAIL;
    }
    buf[ret] = '\0';

    // Parse JSON
    cJSON* root = cJSON_Parse(buf);
    free(buf);

    if (!root) {
        httpd_resp_set_status(req, "400 Bad Request");
        httpd_resp_set_type(req, "application/json");
        httpd_resp_send(req, "{\"error\":\"Invalid JSON\"}", HTTPD_RESP_USE_STRLEN);
        return ESP_OK;
    }

    bool needs_reboot = false;
    bool udp_config_changed = false;

    // Process configuration updates
    // WiFi credential staging (test before commit, no reboot required)
    cJSON* wifi_ssid = cJSON_GetObjectItem(root, "wifi_ssid");
    cJSON* wifi_pass = cJSON_GetObjectItem(root, "wifi_pass");

    if ((wifi_ssid && cJSON_IsString(wifi_ssid)) ||
        (wifi_pass && cJSON_IsString(wifi_pass))) {

        // Both SSID and password must be provided together
        if (!wifi_ssid || !cJSON_IsString(wifi_ssid) ||
            !wifi_pass || !cJSON_IsString(wifi_pass)) {
            cJSON_Delete(root);
            httpd_resp_set_status(req, "400 Bad Request");
            httpd_resp_set_type(req, "application/json");
            httpd_resp_send(req, "{\"error\":\"wifi_incomplete\"}", HTTPD_RESP_USE_STRLEN);
            return ESP_OK;
        }

        ESP_LOGI(TAG, "Testing WiFi credentials for SSID: %s", wifi_ssid->valuestring);

        net_mgr_cred_result_t cred_result;
        esp_err_t test_ret = net_mgr_test_and_commit_credentials(
            wifi_ssid->valuestring,
            wifi_pass->valuestring,
            20000,  // 20 second timeout
            &cred_result
        );

        if (test_ret != ESP_OK) {
            // Staging failed, return error
            const char* error_str = net_mgr_cred_result_to_string(cred_result);
            ESP_LOGW(TAG, "WiFi credential staging failed: %s", error_str);

            cJSON* error_response = cJSON_CreateObject();
            cJSON_AddStringToObject(error_response, "error", error_str);

            char* error_json = cJSON_PrintUnformatted(error_response);
            cJSON_Delete(error_response);
            cJSON_Delete(root);

            if (error_json) {
                httpd_resp_set_type(req, "application/json");
                httpd_resp_send(req, error_json, HTTPD_RESP_USE_STRLEN);
                free(error_json);
            } else {
                httpd_resp_send_500(req);
            }
            return ESP_OK;
        }

        ESP_LOGI(TAG, "WiFi credentials tested and committed successfully");
        // Do NOT set needs_reboot - already connected to new network
    }

    // SNTP config (can be applied at runtime)
    bool sntp_config_changed = false;

    cJSON* sntp_server1 = cJSON_GetObjectItem(root, "sntp_server1");
    if (sntp_server1 && cJSON_IsString(sntp_server1)) {
        config_mgr_set_string("sntp/server1", sntp_server1->valuestring);
        sntp_config_changed = true;
    }

    cJSON* sntp_server2 = cJSON_GetObjectItem(root, "sntp_server2");
    if (sntp_server2 && cJSON_IsString(sntp_server2)) {
        config_mgr_set_string("sntp/server2", sntp_server2->valuestring);
        sntp_config_changed = true;
    }

    cJSON* sntp_timezone = cJSON_GetObjectItem(root, "sntp_timezone");
    if (sntp_timezone && cJSON_IsString(sntp_timezone)) {
        config_mgr_set_string("sntp/timezone", sntp_timezone->valuestring);
        sntp_config_changed = true;
    }

    // Apply SNTP configuration changes at runtime
    if (sntp_config_changed) {
        ESP_LOGI(TAG, "SNTP configuration changed, reloading");
        esp_err_t sntp_ret = sntp_client_reload_config();
        if (sntp_ret != ESP_OK) {
            ESP_LOGE(TAG, "Failed to reload SNTP config: %s", esp_err_to_name(sntp_ret));
        } else {
            ESP_LOGI(TAG, "SNTP configuration reloaded successfully");
        }
    }

    // UDP config (can be applied at runtime)
    cJSON* udp_enabled = cJSON_GetObjectItem(root, "udp_enabled");
    if (udp_enabled && cJSON_IsBool(udp_enabled)) {
        config_mgr_set_bool("udp/enabled", cJSON_IsTrue(udp_enabled));
        udp_config_changed = true;
    }

    cJSON* udp_addr = cJSON_GetObjectItem(root, "udp_addr");
    if (udp_addr && cJSON_IsString(udp_addr)) {
        config_mgr_set_string("udp/addr", udp_addr->valuestring);
        udp_config_changed = true;
    }

    cJSON* udp_port = cJSON_GetObjectItem(root, "udp_port");
    if (udp_port && cJSON_IsNumber(udp_port)) {
        config_mgr_set_u32("udp/port", (uint32_t)udp_port->valuedouble);
        udp_config_changed = true;
    }

    cJSON* udp_freq_hz = cJSON_GetObjectItem(root, "udp_freq_hz");
    if (udp_freq_hz && cJSON_IsNumber(udp_freq_hz)) {
        // Accept frequency as float in Hz (e.g., 1.5)
        float freq_hz = (float)udp_freq_hz->valuedouble;
        // Validate frequency range: 0.2 Hz to 5 Hz (per CLAUDE_TASKS.md)
        if (freq_hz >= 0.2f && freq_hz <= 5.0f) {
            // Convert to millihertz for NVS storage (1 Hz = 1000 mHz)
            // Use rounding to avoid truncation (e.g., 0.2*1000=199.999...  200, not 199)
            uint32_t freq_mhz = (uint32_t)lroundf(freq_hz * 1000.0f);
            config_mgr_set_u32("udp/freq_hz", freq_mhz);
            udp_config_changed = true;
            ESP_LOGI(TAG, "UDP frequency set to %.2f Hz (%lu mHz)", freq_hz, freq_mhz);
        } else {
            ESP_LOGW(TAG, "UDP frequency out of range (0.2-5.0 Hz): %.2f", freq_hz);
        }
    }

    cJSON* udp_ttl = cJSON_GetObjectItem(root, "udp_ttl");
    if (udp_ttl && cJSON_IsNumber(udp_ttl)) {
        uint32_t ttl = (uint32_t)udp_ttl->valuedouble;
        if (ttl >= 1 && ttl <= 255) {
            config_mgr_set_u32("udp/ttl", ttl);
            udp_config_changed = true;
        } else {
            ESP_LOGW(TAG, "UDP TTL out of range (1-255): %lu", ttl);
        }
    }

    cJSON* udp_mode = cJSON_GetObjectItem(root, "udp_mode");
    if (udp_mode && cJSON_IsNumber(udp_mode)) {
        uint32_t mode = (uint32_t)udp_mode->valuedouble;
        // Validate mode: 0=broadcast, 1=multicast, 2=unicast
        if (mode <= 2) {
            config_mgr_set_u32("udp/mode", mode);
            udp_config_changed = true;
        } else {
            ESP_LOGW(TAG, "UDP mode invalid: %lu", mode);
        }
    }

    // Apply UDP configuration changes at runtime (per requirements)
    if (udp_config_changed) {
        ESP_LOGI(TAG, "UDP configuration changed, applying at runtime");

        // Load complete UDP configuration from NVS
        udp_cfg_t udp_cfg = {0};
        config_mgr_get_string("udp/addr", udp_cfg.addr, sizeof(udp_cfg.addr));

        uint32_t temp_u32 = 0;
        if (config_mgr_get_u32("udp/port", &temp_u32) == ESP_OK) {
            udp_cfg.port = (uint16_t)temp_u32;
        }
        if (config_mgr_get_u32("udp/freq_hz", &temp_u32) == ESP_OK) {
            // NVS stores frequency in millihertz; pass it directly without conversion
            // This preserves fractional precision (e.g., 1.5 Hz = 1500 mHz)
            udp_cfg.freq_mhz = (uint16_t)temp_u32;
        }
        if (config_mgr_get_u32("udp/ttl", &temp_u32) == ESP_OK) {
            udp_cfg.ttl = (uint8_t)temp_u32;
        }
        if (config_mgr_get_u32("udp/mode", &temp_u32) == ESP_OK) {
            udp_cfg.mode = (udp_mode_t)temp_u32;
        }

        // Apply configuration to running UDP broadcast module
        esp_err_t apply_ret = udp_broadcast_apply_config(&udp_cfg);
        if (apply_ret != ESP_OK) {
            ESP_LOGE(TAG, "Failed to apply UDP config at runtime: %s", esp_err_to_name(apply_ret));
            // Note: Configuration is still saved to NVS, will apply on next boot
        } else {
            ESP_LOGI(TAG, "UDP configuration applied successfully");
        }
    }

    // Build response
    cJSON* response = cJSON_CreateObject();
    cJSON_AddStringToObject(response, "status", "ok");
    cJSON_AddBoolToObject(response, "needs_reboot", needs_reboot);

    char* json_str = cJSON_PrintUnformatted(response);
    cJSON_Delete(response);
    cJSON_Delete(root);

    if (!json_str) {
        httpd_resp_send_500(req);
        return ESP_FAIL;
    }

    httpd_resp_set_type(req, "application/json");
    httpd_resp_send(req, json_str, HTTPD_RESP_USE_STRLEN);

    free(json_str);
    return ESP_OK;
}

/**
 * POST /ota - Trigger OTA update
 */
static esp_err_t ota_post_handler(httpd_req_t* req)
{
    // Check auth
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    // Read request body
    char* buf = malloc(req->content_len + 1);
    if (!buf) {
        httpd_resp_send_500(req);
        return ESP_FAIL;
    }

    int ret = httpd_req_recv(req, buf, req->content_len);
    if (ret <= 0) {
        free(buf);
        if (ret == HTTPD_SOCK_ERR_TIMEOUT) {
            httpd_resp_send_408(req);
        }
        return ESP_FAIL;
    }
    buf[ret] = '\0';

    // Parse JSON
    cJSON* root = cJSON_Parse(buf);
    free(buf);

    if (!root) {
        httpd_resp_set_status(req, "400 Bad Request");
        httpd_resp_set_type(req, "application/json");
        httpd_resp_send(req, "{\"error\":\"Invalid JSON\"}", HTTPD_RESP_USE_STRLEN);
        return ESP_OK;
    }

    cJSON* url = cJSON_GetObjectItem(root, "url");
    if (!url || !cJSON_IsString(url)) {
        cJSON_Delete(root);
        httpd_resp_set_status(req, "400 Bad Request");
        httpd_resp_set_type(req, "application/json");
        httpd_resp_send(req, "{\"error\":\"Missing 'url' field\"}", HTTPD_RESP_USE_STRLEN);
        return ESP_OK;
    }

    // TODO: Call ota_mgr_trigger_from_url() when Task 7 is implemented
    ESP_LOGI(TAG, "OTA requested from URL: %s (not yet implemented)", url->valuestring);

    cJSON_Delete(root);

    // Send response
    httpd_resp_set_type(req, "application/json");
    httpd_resp_send(req, "{\"status\":\"ota_triggered\"}", HTTPD_RESP_USE_STRLEN);

    return ESP_OK;
}

/**
 * POST /reboot - Reboot device after 1s delay
 */
static esp_err_t reboot_post_handler(httpd_req_t* req)
{
    // Check auth
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    ESP_LOGW(TAG, "Reboot requested via HTTP");

    // Send response first
    httpd_resp_set_type(req, "application/json");
    httpd_resp_send(req, "{\"status\":\"rebooting\"}", HTTPD_RESP_USE_STRLEN);

    // Schedule reboot after 1s (allow response to be sent)
    // Note: In a real implementation, use esp_timer for clean shutdown
    vTaskDelay(pdMS_TO_TICKS(1000));
    esp_restart();

    return ESP_OK;
}

/**
 * GET /logs - Return log ring buffer (placeholder)
 */
static esp_err_t logs_get_handler(httpd_req_t* req)
{
    // Check auth
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    // TODO: Implement log ring buffer in Task 10 (diag module)
    // For now, return placeholder

    httpd_resp_set_type(req, "text/plain");
    httpd_resp_send(req, "Log ring buffer not yet implemented\n", HTTPD_RESP_USE_STRLEN);

    return ESP_OK;
}

/**
 * GET / - Redirect to SPA
 */
static esp_err_t root_redirect_get_handler(httpd_req_t* req)
{
    if (check_basic_auth(req) != ESP_OK) {
        return send_401(req);
    }

    httpd_resp_set_status(req, "302 Found");
    httpd_resp_set_hdr(req, "Location", "/ui");
    httpd_resp_set_hdr(req, "Cache-Control", "no-store");
    httpd_resp_send(req, NULL, 0);
    return ESP_OK;
}

/**
 * GET /favicon.ico - Serve embedded favicon
 */
static esp_err_t favicon_get_handler(httpd_req_t* req)
{
    httpd_resp_set_type(req, "image/x-icon");
    httpd_resp_set_hdr(req, "Cache-Control", "public, max-age=86400");  // Cache for 1 day
    httpd_resp_send(req, (const char*)s_favicon_ico, s_favicon_ico_len);
    return ESP_OK;
}

/**
 * GET /logo.webp - Serve embedded logo
 */
static esp_err_t logo_get_handler(httpd_req_t* req)
{
    httpd_resp_set_type(req, "image/webp");
    httpd_resp_set_hdr(req, "Cache-Control", "public, max-age=86400");  // Cache for 1 day
    httpd_resp_send(req, (const char*)Xtragen_logo_200x62_webp, Xtragen_logo_200x62_webp_len);
    return ESP_OK;
}

// URI handler structures
static const httpd_uri_t status_get = {
    .uri = "/status",
    .method = HTTP_GET,
    .handler = status_get_handler,
    .user_ctx = NULL
};

static const httpd_uri_t config_get = {
    .uri = "/config",
    .method = HTTP_GET,
    .handler = config_get_handler,
    .user_ctx = NULL
};

static const httpd_uri_t ui_spa = {
    .uri = "/ui",
    .method = HTTP_GET,
    .handler = ui_spa_handler,
    .user_ctx = NULL
};

static const httpd_uri_t config_post = {
    .uri = "/config",
    .method = HTTP_POST,
    .handler = config_post_handler,
    .user_ctx = NULL
};

static const httpd_uri_t ota_post = {
    .uri = "/ota",
    .method = HTTP_POST,
    .handler = ota_post_handler,
    .user_ctx = NULL
};

static const httpd_uri_t reboot_post = {
    .uri = "/reboot",
    .method = HTTP_POST,
    .handler = reboot_post_handler,
    .user_ctx = NULL
};

static const httpd_uri_t logs_get = {
    .uri = "/logs",
    .method = HTTP_GET,
    .handler = logs_get_handler,
    .user_ctx = NULL
};

static const httpd_uri_t root_redirect_get = {
    .uri = "/",
    .method = HTTP_GET,
    .handler = root_redirect_get_handler,
    .user_ctx = NULL
};

static const httpd_uri_t favicon_get = {
    .uri = "/favicon.ico",
    .method = HTTP_GET,
    .handler = favicon_get_handler,
    .user_ctx = NULL
};

static const httpd_uri_t logo_get = {
    .uri = "/logo.webp",
    .method = HTTP_GET,
    .handler = logo_get_handler,
    .user_ctx = NULL
};

esp_err_t http_ui_start(void)
{
    ESP_LOGI(TAG, "Starting HTTP server");

    if (s_server) {
        ESP_LOGW(TAG, "HTTP server already running");
        return ESP_OK;
    }

    // Load auth credentials from config_mgr
    esp_err_t ret = config_mgr_get_string("ui/auth_user", s_auth_user, sizeof(s_auth_user));
    if (ret != ESP_OK) {
        ESP_LOGW(TAG, "Failed to load auth user, using default");
        strcpy(s_auth_user, "admin");
    }

    ret = config_mgr_get_string("ui/auth_pass", s_auth_pass, sizeof(s_auth_pass));
    if (ret != ESP_OK) {
        ESP_LOGW(TAG, "Failed to load auth pass, using default");
        strcpy(s_auth_pass, "admin");
    }

    // Security check: Refuse to start with default password (except in setup mode)
    if (config_mgr_has_weak_password()) {
        // Check if we're in setup mode (first 15 minutes after FIRST boot)
        // Use wall-clock time (Unix timestamp) instead of uptime to persist across reboots
        if (s_first_boot_timestamp == 0) {
            uint32_t stored_timestamp = 0;
            esp_err_t ret = config_mgr_get_u32("ui/first_boot_ts", &stored_timestamp);

            if (ret == ESP_OK && stored_timestamp > 0) {
                // Already recorded first boot time, load it
                s_first_boot_timestamp = (time_t)stored_timestamp;
                ESP_LOGI(TAG, "Loaded first boot timestamp from NVS: %lu", (unsigned long)s_first_boot_timestamp);
            } else {
                // First time ever - record current wall-clock time to NVS
                s_first_boot_timestamp = time(NULL);

                // Only persist if we have valid time (not 1970)
                // If time not synced yet, timestamp will be near 0 and setup mode will be very long
                // This is acceptable - better than blocking UI startup before time sync
                if (s_first_boot_timestamp > 0) {
                    config_mgr_set_u32("ui/first_boot_ts", (uint32_t)s_first_boot_timestamp);
                    ESP_LOGW(TAG, "First boot detected - setup mode window started (15 minutes)");
                    ESP_LOGW(TAG, "Stored timestamp: %lu", (unsigned long)s_first_boot_timestamp);
                }
            }
        }

        time_t current_time = time(NULL);
        time_t elapsed_sec = current_time - s_first_boot_timestamp;

        if (elapsed_sec < SETUP_MODE_DURATION_SEC) {
            time_t remaining_min = (SETUP_MODE_DURATION_SEC - elapsed_sec) / 60;
            ESP_LOGW(TAG, "========================================");
            ESP_LOGW(TAG, "SETUP MODE: Default password accepted");
            ESP_LOGW(TAG, "Time remaining: %ld minutes", (long)remaining_min);
            ESP_LOGW(TAG, "Change password immediately via /config");
            ESP_LOGW(TAG, "This window persists across reboots!");
            ESP_LOGW(TAG, "HTTP UI will be disabled when setup mode expires");
            ESP_LOGW(TAG, "========================================");
        } else {
            ESP_LOGE(TAG, "========================================");
            ESP_LOGE(TAG, "SECURITY ERROR: HTTP UI disabled");
            ESP_LOGE(TAG, "Setup mode expired - default password 'admin' not allowed");
            ESP_LOGE(TAG, "Change password via config_mgr API to enable HTTP UI");
            ESP_LOGE(TAG, "========================================");
            return ESP_ERR_INVALID_STATE;
        }
    }

    // Generate auth digest
    ret = generate_auth_digest(s_auth_user, s_auth_pass, s_auth_digest, sizeof(s_auth_digest));
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Failed to generate auth digest: %s", esp_err_to_name(ret));
        return ret;
    }

    // Start HTTP server
    httpd_config_t config = HTTPD_DEFAULT_CONFIG();
    config.lru_purge_enable = true;
    config.max_uri_handlers = 12;  // Increased from default 8 to accommodate all handlers

    ret = httpd_start(&s_server, &config);
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Failed to start HTTP server: %s", esp_err_to_name(ret));
        return ret;
    }

    // Register URI handlers (root redirect first for default landing page)
    httpd_register_uri_handler(s_server, &root_redirect_get);
    httpd_register_uri_handler(s_server, &favicon_get);
    httpd_register_uri_handler(s_server, &logo_get);
    httpd_register_uri_handler(s_server, &ui_spa);        // Single Page Application
    httpd_register_uri_handler(s_server, &status_get);    // JSON API
    httpd_register_uri_handler(s_server, &config_get);    // JSON API
    httpd_register_uri_handler(s_server, &config_post);   // JSON API
    httpd_register_uri_handler(s_server, &ota_post);
    httpd_register_uri_handler(s_server, &reboot_post);
    httpd_register_uri_handler(s_server, &logs_get);

    ESP_LOGI(TAG, "HTTP server started on port %d", config.server_port);

    return ESP_OK;
}

esp_err_t http_ui_stop(void)
{
    if (!s_server) {
        return ESP_OK;
    }

    ESP_LOGI(TAG, "Stopping HTTP server");

    esp_err_t ret = httpd_stop(s_server);
    if (ret == ESP_OK) {
        s_server = NULL;
    }

    return ret;
}

esp_err_t http_ui_update_auth(const char* user, const char* pass)
{
    if (!user || !pass) {
        return ESP_ERR_INVALID_ARG;
    }

    ESP_LOGI(TAG, "Updating auth credentials");

    // Update stored credentials
    strlcpy(s_auth_user, user, sizeof(s_auth_user));
    strlcpy(s_auth_pass, pass, sizeof(s_auth_pass));

    // Regenerate auth digest
    esp_err_t ret = generate_auth_digest(s_auth_user, s_auth_pass, s_auth_digest, sizeof(s_auth_digest));
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Failed to regenerate auth digest: %s", esp_err_to_name(ret));
        return ret;
    }

    // Persist to NVS
    config_mgr_set_string("ui/auth_user", user);
    config_mgr_set_string("ui/auth_pass", pass);

    return ESP_OK;
}
